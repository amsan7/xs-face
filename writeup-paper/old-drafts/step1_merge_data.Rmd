---
title: 'XS-Face: Merge Raw Data'
author: "Bria Long, continued from MCF document merge_all_data.r"
date: "11/6/2018"
output: html_document
---
# Step 0: Libraries and helper functions
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls()) # remove all objects from current workspace
library(dplyr)
library(readr)
library(magrittr)
library(tidyr)
library(assertthat)
source("helper.R") # Contains critical helper functions for merging annotations
```

## Step 1: Load detectors
### Load detectors from MTCNN
```{r}
dets_MTCNN <- read_csv("../data/final_detector_output/mtcnn3.csv") %>%
  mutate(subid = video) %>%
  mutate(frame = as.numeric(frame)) %>%
  mutate(faceMT = as.logical(is_face)) %>%
  distinct(video,frame,.keep_all=TRUE)   
```

### Load Viola-Jones detectors
```{r}
detsViola <- read_csv("../data/final_detector_output/viola.csv") 
detsViola <- detsViola %>%
  distinct(video,frame,.keep_all=TRUE)  %>%
  mutate(faceVJ = as.logical(is_face))  %>%
  mutate(frame = as.numeric(frame)) 
```

### Load OpenPose detections (face and wrists)
Wrists: if right or left wrist was ever detected
Faces: If nose was ever detected

```{r}
detsOpenPose <- read_csv("../data/final_detector_output/openpose_results_truncated_2.csv") 
detsOpenPose <- detsOpenPose %>%
  mutate(video = name) %>%
  distinct(video,frame,.keep_all=TRUE)  %>%
  mutate(frame = as.numeric(frame) + 1) %>% ## Frame output is off by one since we extracted from videos vs. frames.
  mutate(faceOP = Nose_conf!=0)  %>%  
  mutate(wristOP = LWrist_conf!=0 | RWrist_conf!=0 )%>%
  mutate(armOP = LElbow_conf!=0 | RElbow_conf!=0)
```

## Step 2:  Merge detectors and sanity check
```{r}
assert_that(dim(dets_MTCNN)[1]==dim(detsViola)[1]) 
alldets=left_join(dets_MTCNN,detsViola[,c("video","frame","faceVJ")])  ## Join MTCNN + Viola Jones
alldets=left_join(alldets,detsOpenPose[,c("video","frame","faceOP","wristOP")])  ##  ++ OpenPose
```

### Sanity checks for merging detectors
We know that openPose works on videos and so might notget all frames. Let's check out the frames it doesn't have

```{r}
# First -- MTCNN v Viola Joes
# These were done on the same frames, so should work

## 
missingInd=is.na(alldets$faceOP)
assert_that(sum(is.na(alldets$faceOP))==45)

maxFrameNum <- alldets %>%
  group_by(video) %>%
  summarize(maxFrame = max(frame))

## Let's look at which frames these are
missingOP<- alldets %>% 
  filter(missingInd) %>%
  group_by(video) %>%
  left_join(maxFrameNum) %>%
  summarize(numPerSub = n(), isFaceMTCNN = sum(faceMT), isFaceJF = sum(faceVJ), missingFrameStart = min(frame), maxFrameNum = maxFrame[1])
  
```

Open pose seems to be skipping between 2-13 frames for 7 subjects for a total of 45 frames. There's no way to gaurentee that these actually come from the end of the videos, 45 frames is less than 2 seconds of video overall so we're OK with that margin of error

#### None of the missing frames are faces. Replace OpenPose "NAN" detections with "FALSE"
```{r}
alldets$faceOP[missingInd]=FALSE 
alldets$wristOP[missingInd]=FALSE

# detectors are reasonably colinear
MTvsOP = mean(alldets$faceOP==alldets$faceMT)
VJvsOP = mean(alldets$faceOP==alldets$faceVJ)
```

#### Rearrange alldets we make sure it is in the order of the frames
```{r}
alldets<-arrange(alldets,video,frame) 
```

## Step 3. Merge demographics and manual annotations
```{r}
# load demographics and pose / orientation / timing
demo.data <- read_csv("../data/demographics/demographics.csv") %>% 
  select(-ra, -assist, -len) ## -dot -dib fields did not exist, deleted bll
```

### Merge in frame times, postures, and orientations
```{r}
# calls helper functions in helper.r to get times and posture coding integrated
d <- alldets %>%
  select(-c(is_face,video)) %>% # redudant with faceMT & subid, dropping
  left_join(demo.data) %>% # join demographics info 
  group_by(subid) %>% # get subid
  do(add.times(.)) %>%  # calls helper functions to add times
  group_by(subid) %>%
  do(add.posture(.)) ## adds both postures and orientatinos
```

#### Check that we synced everything right -- no duplicate timestamps
```{r}
test <- d %>%
  mutate(isDuplicate = (dt==0)) %>%
  group_by(subid) %>%
  summarize(duplicateCount = sum(isDuplicate))

assert_that(sum(is.na(d$dt))==0)
assert_that(sum(test$duplicateCount)==0)
assert_that(sum(is.na(d$time))==0)
```


### Complete the data frame 
So that zeros get counted: expands so that each subid includes a zero length row for each posture and orientation.
This was annoying.
```{r}
ages <- d %>%
  group_by(subid) %>%
  summarise(age.grp = age.grp[1], age.at.test = age.at.test[1])  ## added age.at.test

complete_combos <- tidyr::expand(d, nesting(posture, orientation), subid) %>% 
  mutate(dt = 0, faceMT = FALSE, faceVJ = FALSE, faceOP = FALSE, handOP = FALSE, wristOP = FALSE) %>%
  left_join(ages)

d <- bind_rows(d, complete_combos) ## bind these 251 data points
```

# Step 4: Save out the data
```{r}
# write_csv(d, "../data/consolidated_data/consolidated_data_4detectors_test.csv") #
```
